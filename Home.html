<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homepage</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 5px; margin: 5px 0; }
    .section { margin-bottom: 20px; }
    .request, .connection { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h2 id="userInfo"></h2>

  <div class="section">
    <h3>Connections</h3>
    <div id="connections">Loading...</div>
  </div>

  <div class="section">
    <h3>Pending Requests</h3>
    <div id="requests">Loading...</div>
  </div>

  <div class="section">
    <h3>Send Connection Request</h3>
    <input type="number" id="receiverId" placeholder="Enter user ID">
    <button id="sendRequestBtn">Send Request</button>
    <p id="sendMessage"></p>
  </div>

<script>
const user = JSON.parse(localStorage.getItem("UserData"));
const userInfoEl = document.getElementById("userInfo");
const connectionsEl = document.getElementById("connections");
const requestsEl = document.getElementById("requests");
const sendRequestBtn = document.getElementById("sendRequestBtn");
const receiverIdInput = document.getElementById("receiverId");
const sendMessageEl = document.getElementById("sendMessage");
const API = "https://proliferous-inconclusively-callen.ngrok-free.dev";
userInfoEl.textContent = `Logged in as: ${user.email} (ID: ${user.id})`;

async function fetchConnections() {


    try {
        const res = await fetch( API+"retreiveConnectionsData", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: user.id })
        });
        const data = await res.json();

       
        if (data.Connections.length > 0) {
            connectionsEl.innerHTML = data.Connections.map(c => `<div class="connection">${c.email} (ID: ${c.id})</div>`).join("");
        } else {
            connectionsEl.textContent = "No connections yet.";
        }

       
        if (data.Requests.length > 0) {
            requestsEl.innerHTML = data.Requests.map(r => 
                `<div class="request">
                    Request from ID: ${r.senderId} 
                    <button onclick="acceptRequest(${r.senderId})">Accept</button>
                </div>`
            ).join("");
        } else {
            requestsEl.textContent = "No pending requests.";
        }

    } catch(err) {
        console.error(err);
        connectionsEl.textContent = "Error loading connections.";
        requestsEl.textContent = "Error loading requests.";
    }
}

async function sendRequest() {
    const receiverId = parseInt(receiverIdInput.value);
    if (!receiverId) {
        sendMessageEl.textContent = "Enter a valid user ID";
        return;
    }

    try {
        const res = await fetch(API+"sendConnctionRequest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ senderId: user.id, receiverId })
        });
        const data = await res.json();
        sendMessageEl.textContent = data.message;
        receiverIdInput.value = "";
        fetchConnections(); 
    } catch(err) {
        console.error(err);
        sendMessageEl.textContent = "Error sending request";
    }
}

async function acceptRequest(senderId) {
    try {
        const res = await fetch(API+"acceptRequest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: user.id, senderId })
        });
        const data = await res.json();
        alert(data.message);
        fetchConnections(); 
    } catch(err) {
        console.error(err);
        alert("Error accepting request");
    }
}

sendRequestBtn.addEventListener("click", sendRequest);


fetchConnections();
</script>
</body>
</html>
